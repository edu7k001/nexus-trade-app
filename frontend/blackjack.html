<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blackjack - Nexus Trade</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <header class="header">
        <div class="container header-content">
            <div class="logo">
                <img src="https://via.placeholder.com/120x40/1e293b/f5b342?text=NEXUS" alt="Nexus Trade">
                <span>NEXUS TRADE</span>
            </div>
            <nav class="nav-menu">
                <a href="/dashboard" class="nav-link"><i class="fas fa-home"></i> In√≠cio</a>
                <a href="/slot" class="nav-link"><i class="fas fa-dice"></i> Slots</a>
                <a href="/dice" class="nav-link"><i class="fas fa-dice-d6"></i> Dados</a>
                <a href="/crash" class="nav-link"><i class="fas fa-plane"></i> Avi√£o</a>
                <a href="/roulette" class="nav-link"><i class="fas fa-circle"></i> Roleta</a>
                <a href="/blackjack" class="nav-link active"><i class="fas fa-spade"></i> Blackjack</a>
                <a href="/affiliates" class="nav-link"><i class="fas fa-users"></i> Afiliados</a>
            </nav>
            <div class="user-area">
                <div class="balance-box" onclick="showDepositModal()">
                    <i class="fas fa-wallet balance-icon"></i>
                    <span class="balance-value" id="user-balance">R$ 0,00</span>
                </div>
                <div class="user-profile">
                    <div class="avatar" id="user-avatar">U</div>
                    <span class="user-name" id="user-name">Carregando</span>
                    <i class="fas fa-sign-out-alt logout-btn" onclick="logout()"></i>
                </div>
            </div>
        </div>
    </header>

    <main class="container">
        <div class="game-container">
            <h2 class="game-title">üÉè BLACKJACK</h2>

            <!-- M√£o do dealer -->
            <div class="blackjack-hand" id="blackjack-dealer-hand"></div>

            <!-- M√£o do jogador -->
            <div class="blackjack-hand" id="blackjack-player-hand"></div>

            <!-- A√ß√µes do jogo -->
            <div class="blackjack-actions">
                <button class="blackjack-btn" id="blackjack-hit" onclick="blackjackHit()" disabled>HIT</button>
                <button class="blackjack-btn" id="blackjack-stand" onclick="blackjackStand()" disabled>STAND</button>
            </div>

            <!-- Controles de aposta -->
            <div class="bet-controls">
                <input type="number" id="blackjack-bet" class="bet-input" min="5" value="10" step="5">
                <button class="play-btn" id="blackjack-start" onclick="blackjackStart()">NOVA M√ÉO</button>
            </div>

            <!-- Resultado -->
            <div id="blackjack-result" class="result-box hidden"></div>
        </div>
    </main>

    <!-- Modal QR Code (dep√≥sito) -->
    <div id="qr-modal" class="modal">
        <div class="modal-content">
            <button class="btn-close" onclick="closeModal()" style="position:absolute;top:10px;right:10px;background:none;border:none;color:white;font-size:24px;">√ó</button>
            <h2 style="color:var(--primary);">üí∞ DEP√ìSITO PIX</h2>
            <div class="quick-amounts">
                <button class="quick-amount-btn" onclick="setDepositAmount(20)">R$20</button>
                <button class="quick-amount-btn" onclick="setDepositAmount(30)">R$30</button>
                <button class="quick-amount-btn" onclick="setDepositAmount(50)">R$50</button>
                <button class="quick-amount-btn" onclick="setDepositAmount(100)">R$100</button>
                <button class="quick-amount-btn" onclick="setDepositAmount(200)">R$200</button>
                <button class="custom-amount-btn" onclick="setCustomAmount()">OUTRO</button>
            </div>
            <div id="custom-amount-container" style="display:none; margin-bottom:20px;">
                <input type="number" id="custom-amount" class="bet-input" placeholder="Digite o valor" min="20" step="5" style="width:100%;">
            </div>
            <img id="qr-code-img" class="qr-image" src="" alt="QR Code">
            <p id="pix-key-display" style="word-break:break-all; background:rgba(0,0,0,0.3); padding:10px; border-radius:5px;"></p>
            <div style="display:flex; gap:10px;">
                <button class="copy-btn" onclick="copyPixKey()"><i class="fas fa-copy"></i> COPIAR</button>
                <button class="copy-btn" onclick="confirmDepositRequest()" style="background:var(--success);"><i class="fas fa-check"></i> J√Å DEPOSITEI</button>
            </div>
        </div>
    </div>

    <div class="live-notifications" id="live-notifications"></div>

    <script src="script.js"></script>
    <script>
        // Vari√°veis de estado do jogo
        let blackjackGameActive = false;
        let blackjackBet = 0;
        let playerCards = [];
        let dealerCards = [];
        let playerSum = 0;
        let dealerCard = 0;

        // Fun√ß√£o para converter n√∫mero em s√≠mbolo de carta (simplificado)
        function cardSymbol(value) {
            return value; // Por enquanto apenas o n√∫mero
        }

        // Inicia uma nova m√£o
        async function blackjackStart() {
            if (!userData) {
                alert('Usu√°rio n√£o carregado. Tente novamente.');
                return;
            }
            if (userData.status === 'Pendente' && !hasDeposited) {
                showDepositPopup('first-time');
                return;
            }
            if (userData.balance <= 0) {
                showDepositPopup('zero');
                return;
            }
            const bet = parseFloat(document.getElementById('blackjack-bet').value);
            if (bet > userData.balance) {
                showDepositPopup('zero');
                return;
            }
            if (bet < 5) {
                alert('Aposta m√≠nima: R$5');
                return;
            }

            blackjackBet = bet;

            try {
                const response = await fetch('/api/game/blackjack', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: userData.id, betAmount: bet, action: 'start' })
                });
                const data = await response.json();

                if (response.ok) {
                    // Atualiza saldo
                    userData.balance = data.newBalance;
                    updateUI();

                    // Exibe as cartas
                    playerCards = data.playerCards;
                    dealerCard = data.dealerCard;
                    playerSum = data.playerSum;

                    document.getElementById('blackjack-player-hand').innerHTML = playerCards.map(c => `<div class="blackjack-card">${c}</div>`).join('');
                    document.getElementById('blackjack-dealer-hand').innerHTML = `<div class="blackjack-card">${dealerCard}</div><div class="blackjack-card">?</div>`;

                    // Habilita bot√µes de a√ß√£o
                    document.getElementById('blackjack-hit').disabled = false;
                    document.getElementById('blackjack-stand').disabled = false;
                    document.getElementById('blackjack-start').disabled = true;
                    blackjackGameActive = true;

                    // Se j√° tiver blackjack, mostra resultado
                    if (data.win > 0) {
                        document.getElementById('blackjack-result').classList.remove('hidden', 'win', 'lose');
                        document.getElementById('blackjack-result').classList.add('win');
                        document.getElementById('blackjack-result').innerHTML = data.message;
                        blackjackGameActive = false;
                        document.getElementById('blackjack-hit').disabled = true;
                        document.getElementById('blackjack-stand').disabled = true;
                        document.getElementById('blackjack-start').disabled = false;
                    }
                } else {
                    alert('Erro: ' + (data.error || 'Desconhecido'));
                }
            } catch (error) {
                alert('Erro de conex√£o');
            }
        }

        // Fun√ß√£o HIT (simplificada - apenas simula√ß√£o local)
        async function blackjackHit() {
            if (!blackjackGameActive) return;
            // Em uma vers√£o completa, chamaria o backend para nova carta
            // Por simplicidade, vamos apenas simular uma carta aleat√≥ria
            const newCard = Math.floor(Math.random() * 10) + 1;
            playerCards.push(newCard);
            playerSum += newCard;

            document.getElementById('blackjack-player-hand').innerHTML = playerCards.map(c => `<div class="blackjack-card">${c}</div>`).join('');

            if (playerSum > 21) {
                // Estourou
                document.getElementById('blackjack-result').classList.remove('hidden', 'win', 'lose');
                document.getElementById('blackjack-result').classList.add('lose');
                document.getElementById('blackjack-result').innerHTML = `üò¢ ESTOUROU! Perdeu R$ ${blackjackBet.toFixed(2)}`;
                blackjackGameActive = false;
                document.getElementById('blackjack-hit').disabled = true;
                document.getElementById('blackjack-stand').disabled = true;
                document.getElementById('blackjack-start').disabled = false;
            }
        }

        // Fun√ß√£o STAND (simplificada)
        async function blackjackStand() {
            if (!blackjackGameActive) return;
            // Simples: dealer ganha se tiver mais que o jogador
            const dealerTotal = dealerCard + Math.floor(Math.random() * 10) + 1; // simula segunda carta
            let message = '';
            let winClass = 'lose';
            let winAmount = 0;

            if (dealerTotal > 21 || playerSum > dealerTotal) {
                message = `üéâ VIT√ìRIA! Dealer: ${dealerTotal}, Voc√™: ${playerSum}`;
                winClass = 'win';
                winAmount = blackjackBet;
                userData.balance += winAmount;
                updateUI();
            } else if (playerSum === dealerTotal) {
                message = `ü§ù EMPATE! Dealer: ${dealerTotal}, Voc√™: ${playerSum}`;
                winClass = 'win'; // ou poderia ser um empate
                userData.balance += blackjackBet; // devolve a aposta
                updateUI();
            } else {
                message = `üò¢ PERDEU! Dealer: ${dealerTotal}, Voc√™: ${playerSum}`;
            }

            document.getElementById('blackjack-dealer-hand').innerHTML = `<div class="blackjack-card">${dealerCard}</div><div class="blackjack-card">${dealerTotal - dealerCard}</div>`;
            document.getElementById('blackjack-result').classList.remove('hidden', 'win', 'lose');
            document.getElementById('blackjack-result').classList.add(winClass);
            document.getElementById('blackjack-result').innerHTML = message;

            blackjackGameActive = false;
            document.getElementById('blackjack-hit').disabled = true;
            document.getElementById('blackjack-stand').disabled = true;
            document.getElementById('blackjack-start').disabled = false;
        }

        // Inicializa os dados do usu√°rio
        loadUserData();
    </script>
</body>
</html>